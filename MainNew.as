package {	import Utlis.*;		import caurina.transitions.Tweener;		import com.adobe.serialization.json.JSON;	import com.blixtsystems.audio.MixerShader;	import com.facebook.graph.Facebook;	import com.pimedius.MixRecorderNew;	import com.pimedius.MixRecorderEvent;		import components.CustomSound;	import components.CustomSoundEvent;	import components.SoundButton;	import components.SoundButtonEvent;		import flash.display.MovieClip;	import flash.events.Event;	import flash.events.KeyboardEvent;	import flash.events.MouseEvent;	import flash.events.ProgressEvent;	import flash.events.TimerEvent;	import flash.external.ExternalInterface;	import flash.media.Sound;	import flash.media.SoundChannel;	import flash.media.SoundTransform;	import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.net.URLRequestMethod;	import flash.net.URLVariables;	import flash.net.navigateToURL;	import flash.net.registerClassAlias;	import flash.utils.Timer;	public class MainNew extends MovieClip {				static const BUFFER_SIZE:int = 2048;				var soundArray:Array;		var soundButtonArray:Array;		var playingQueue:Array;				var s1:Sound;		var s2:Sound;		var channel1:SoundChannel;		var channel2:SoundChannel;				var recorder:MixRecorderNew;		var xmlData:XML;		var myLoader:URLLoader;				var savedLink:String;				private var columns:int;		private var padding:int;		private var horizontal_align:Boolean;		private var vertical_align:Boolean;		private var scale:int;				var soundButtonsHolder:MovieClip;		var timer:Timer;		var mixLength:int=30;		var savePath:String;				public function MainNew() {			// constructor code			trace("START APP");//			Facebook.init("349961031709801", onInit);			Facebook.init("395785903780257", onInit);			var opts:Object = {scope:"publish_stream, user_photos"};			Facebook.login(onLogin, opts);			savedLink=new String();						recorder=new MixRecorderNew();			recorder.statusTextField=statusTxt;			recorder.savedLink=savedLink;			soundButtonArray=new Array();			soundArray=new Array();			playingQueue=new Array();												soundButtonsHolder=new MovieClip();			soundButtonsHolder.x=15;			soundButtonsHolder.y=15;						addChild(soundButtonsHolder);						record_btn.addEventListener(MouseEvent.CLICK, onClickRecord);			//stopRec_btn.addEventListener(MouseEvent.CLICK, onClickStopRecord);//			playRecorded_btn.addEventListener(MouseEvent.CLICK, onClickPlayRecorded);//			convert_btn.addEventListener(MouseEvent.CLICK, onClickConvert);			statusTxt.text="";//			share.addEventListener(MouseEvent.CLICK, onClickShare);						myLoader = new URLLoader();			myLoader.load(new URLRequest("contentBreakBeat.xml"));			myLoader.addEventListener(Event.COMPLETE, processXML);						timer=new Timer(1000,mixLength);			timer.addEventListener(TimerEvent.TIMER,secondElapsed);		}				function secondElapsed(e:TimerEvent):void{			trace(timer.currentCount);			statusTxt.text="Remaining time: "+(mixLength-timer.currentCount)+" sec";			if(timer.currentCount==mixLength){				stopRecording();				timer.reset();			}		}				function processXML(e:Event):void {			xmlData = new XML(e.target.data);						columns=parseInt(xmlData.config.columns);			padding=parseInt(xmlData.config.padding);						if(xmlData.config.horizontal_align=="true"){				horizontal_align=true;			}else{				horizontal_align=false;			}						if(xmlData.config.vertical_align=="true"){				vertical_align=true;			}else{				vertical_align=false;			}			savePath=xmlData.config.save_path;						trace(savePath);			recorder.savePath=savePath;			scale=parseFloat(xmlData.config.scale);			setupButtons();					}						function setupButtons():void{			for(var i=0; i<xmlData.sound.length();i++){				soundButtonArray.push(new SoundButton(soundButtonArray.length, xmlData.sound[i].title.toString(), xmlData.sound[i].key.toString(), false, parseFloat(xmlData.sound[i].volume), parseFloat(xmlData.sound[i].panning) ));				var current=soundButtonArray.length-1;				soundButtonArray[current].x=i*(soundButtonArray[current].width+padding);				soundButtonsHolder.addChild(soundButtonArray[current]);				soundButtonArray[current].addEventListener(SoundButtonEvent.MOUSE_DOWN,soundButtonPressed);				soundArray.push(new CustomSound(current,new URLRequest(xmlData.sound[i].path.toString())));			}						for(i=0; i<xmlData.loop.length();i++){				soundButtonArray.push(new SoundButton(soundButtonArray.length, xmlData.loop[i].title.toString(), xmlData.loop[i].key.toString(), true, parseFloat(xmlData.loop[i].volume), parseFloat(xmlData.loop[i].panning) ));				current=soundButtonArray.length-1;				soundButtonArray[current].x=i*(soundButtonArray[current].width+padding);				soundButtonArray[current].y=(soundButtonArray[current].height+padding);				soundButtonsHolder.addChild(soundButtonArray[current]);				soundButtonArray[current].addEventListener(SoundButtonEvent.MOUSE_DOWN,soundButtonPressed);				soundArray.push(new CustomSound(current,new URLRequest(xmlData.loop[i].path.toString())));			}			addKeyListener();		}				function addKeyListener():void{			stage.addEventListener(KeyboardEvent.KEY_UP, keyDownListener);		}				function removeKeyListener():void{			stage.removeEventListener(KeyboardEvent.KEY_UP, keyDownListener);		}				private function keyDownListener(e:KeyboardEvent):void {			var character:String = String.fromCharCode(e.charCode);			for(var i=0;i<soundButtonArray.length;i++){				var tempId:String=soundButtonArray[i].keyValue;				if(tempId==character || tempId.toLowerCase()==character){					if(soundButtonArray[i].looping && soundButtonArray[i].playingState){						soundButtonArray[i].switchState();						stopSounds(soundButtonArray[i].id);					}else{												soundButtonArray[i].switchState();						addSoundToQueue(soundArray[i],soundButtonArray[i].looping);					}					break;				}			}						}				function soundButtonPressed(e:SoundButtonEvent):void{			if(e.target.looping && e.target.playingState){				stopSounds(e.target.id);				e.target.switchState();			}else{				addSoundToQueue(soundArray[e.target.id],e.target.looping);				e.target.switchState();			}		}				function stopSounds(id:int):void{			for(var i=0;i<playingQueue.length;i++){				if(playingQueue[i].id==id){					playingQueue[i].removeEventListener(CustomSoundEvent.COMPLETE,queueSoundComplete);					playingQueue[i].addEventListener(CustomSoundEvent.STOPED,queueSoundStoped);					playingQueue[i].stopSound();					break;				}			}		}				function addSoundToQueue(snd:CustomSound,looping:Boolean=false):void{			var q_sound:CustomSound = new CustomSound(snd.id);//			q_sound.sound=new Sound(new URLRequest(snd.path));			q_sound.sound=snd.sound;//			q_sound.sound=new d_drumz();			q_sound.addEventListener(CustomSoundEvent.COMPLETE,queueSoundComplete);			playingQueue.push(q_sound);			q_sound.queueId=playingQueue.length-1;						q_sound.playSound(looping);			recorder.addSound(q_sound.sound);		}				function queueSoundComplete(e:CustomSoundEvent):void{			e.target.removeEventListener(CustomSoundEvent.COMPLETE,queueSoundComplete);			for(var i=0;i<playingQueue.length;i++){				if(playingQueue[i]==e.target){					var doesLoop=playingQueue[i].loop;					var loopId=playingQueue[i].id;					recorder.removeSound(playingQueue[i].sound);					playingQueue.splice(i,1);					if(doesLoop){						addSoundToQueue(soundArray[loopId],true);					}					break;				}			}		}				function queueSoundStoped(e:CustomSoundEvent):void{			e.target.removeEventListener(CustomSoundEvent.STOPED,queueSoundStoped);						for(var i=0;i<playingQueue.length;i++){				if(playingQueue[i]==e.target){					var doesLoop=playingQueue[i].loop;					var loopId=playingQueue[i].id;					recorder.removeSound(playingQueue[i].sound);					playingQueue.splice(i,1);					break;				}			}		}				function onClickRecord(e:MouseEvent):void{			recorder.startRecording();			e.target.removeEventListener(MouseEvent.CLICK, onClickRecord);			e.target.addEventListener(MouseEvent.CLICK, onClickStopRecord);				playRecorded_btn.removeEventListener(MouseEvent.CLICK, onClickPlayRecorded);			e.target.gotoAndStop("_on");			share.removeEventListener(MouseEvent.CLICK, onClickShare);			Tweener.addTween(share, {alpha:0.4,time:0.5,transition:"easeOutQuad"});			Tweener.addTween(playRecorded_btn, {alpha:0.4,time:0.5,transition:"easeOutQuad"});			timer.start();		}				function onClickStopRecord(e:MouseEvent):void{			timer.reset();			stopRecording();		}				function stopRecording():void{			recorder.stopRecording();			record_btn.addEventListener(MouseEvent.CLICK, onClickRecord);			record_btn.removeEventListener(MouseEvent.CLICK, onClickStopRecord);			playRecorded_btn.addEventListener(MouseEvent.CLICK, onClickPlayRecorded);			record_btn.gotoAndStop("_off");			share.addEventListener(MouseEvent.CLICK, onClickShare);			Tweener.addTween(share, {alpha:1,time:0.5,transition:"easeOutQuad"});			Tweener.addTween(playRecorded_btn, {alpha:1,time:0.5,transition:"easeOutQuad"});			statusTxt.text="";		}				function onClickPlayRecorded(e:MouseEvent):void{			e.target.gotoAndStop("_on");			recorder.playRecorded();			recorder.addEventListener(MixRecorderEvent.COMPLETE,playbackCompleteOrStoped);			recorder.addEventListener(MixRecorderEvent.STOPED,playbackCompleteOrStoped);		}				function playbackCompleteOrStoped(e:MixRecorderEvent):void{			playRecorded_btn.gotoAndStop("_off");			recorder.removeEventListener(MixRecorderEvent.COMPLETE,playbackCompleteOrStoped);			recorder.removeEventListener(MixRecorderEvent.STOPED,playbackCompleteOrStoped);		}				function onClickConvert(e:MouseEvent):void{			//		}				function encodingComplete(e:Event):void{			recorder.removeEventListener(Event.COMPLETE,encodingComplete);			ExternalInterface.call("streamPublish",recorder.savedLink);		}				function onClickShare(e:MouseEvent):void{				record_btn.removeEventListener(MouseEvent.CLICK, onClickRecord);			recorder.addEventListener(Event.COMPLETE,encodingComplete);						share.removeEventListener(MouseEvent.CLICK, onClickShare);						Tweener.addTween(record_btn, {alpha:0.4,time:0.5,transition:"easeOutQuad"});			recorder.metaData=new Array("Song title","Artist name","Album name", "1982","Apsurdno dugi koment koji ce se skratiti na 30 znakova cisto onako iz fore");			recorder.convertToMP3();								}						function yourUICallback(result:Object):void {			trace("FACEBOOK CALLBACK")			trace("result="+JSON.encode(result));					}				function yourCallback(result:Object, fail:Object):void {			trace("FACEBOOK CALLBACK")			if (result) {				trace("result="+JSON.encode(result));			} else if (fail) {				trace("fail="+JSON.encode(fail));			}		}				function onInit(result:Object, fail:Object):void {				trace("onInit")			if (result) { //already logged in because of existing session				trace("onInit, Logged In");			} else {				trace("onInit, Not Logged In");			}		}				protected function onLogin(result:Object, fail:Object):void {			if (result) { //successfully logged in				trace("Logged In");			} else {				trace("Login Failed");							}		}				protected function onLogout(success:Boolean):void {						trace("Logged Out");					}						/*protected function handleCallApiClick(event:MouseEvent):void {			var requestType:String = getRadio.selected ? "GET" : "POST";			var params:Object = null;				if (requestType == "POST") {				try {					params = JSON.decode(paramsInput.text);				} catch (e:Error) {					outputTxt.appendText("\n\nERROR DECODING JSON: " + e.message);				}			}						Facebook.api(methodInput.text, onCallApi, params, requestType); //use POST to send data (as per Facebook documentation)		}*/				/*protected function handleUIClick(event:MouseEvent):void {						var method:String = uiMethodInput.text;			if (method.length) {				var data:Object = {};				try {					data = JSON.decode(uiParamsInput.text);					} catch (e:Error) {					outputTxt.appendText("\n\nERROR DECODING JSON: " + e.message);				}											Facebook.ui(method, data, onUICallback);			} else {				outputTxt.appendText("\n\nPlease specify dialog type");			}		}*/				protected function onUICallback(result:Object):void {			trace("\n\nUICallback: " + JSON.encode(result));		}				protected function onCallApi(result:Object, fail:Object):void {			if (result) {				trace("\n\nRESULT:\n" + JSON.encode(result)); 			} else {				trace("\n\nFAIL:\n" + JSON.encode(fail)); 			}		}				protected function handleClearClick(event:MouseEvent):void {					}	}}